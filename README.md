# 🏫 智能教室座位预约系统 v2

基于 Django 5.2 开发的智能教室座位预约系统，支持可视化选座、邮件通知、多用户角色管理等功能。

---

## 📋 目录

1. [功能概述](#功能概述)
2. [系统架构](#系统架构)
3. [安装与配置](#安装与配置)
4. [用户手册](#用户手册)
5. [管理员手册](#管理员手册)
6. [配置说明](#配置说明)
7. [定时任务](#定时任务)

---

## 功能概述

### ✅ 已实现功能

#### 用户功能
| 功能 | 说明 |
|------|------|
| 📝 学号登录 | 输入学号即可登录，首次登录自动注册 |
| 🔐 密码设置 | 可选设置登录密码，通过邮件确认重置 |
| 🪑 可视化选座 | 直观的座位布局图，支持多选座位 |
| 📅 多日期多时段 | 支持选择不同日期和时间段预约 |
| 📋 我的预约 | 查看所有预约记录，支持状态筛选 |
| ❌ 取消预约 | 在截止时间前可取消待审核/已通过的预约 |
| ⬆️ 申请升级 | 普通用户可申请成为负责人/VIP |
| 📧 邮件通知 | 预约审批结果、门禁密码等通过邮件通知 |

#### 管理员功能
| 功能 | 说明 |
|------|------|
| 🖥️ Django Admin 后台 | 完整的数据管理界面 |
| ✅ 邮件一键审批 | 通过邮件链接直接批准/拒绝预约 |
| 🪑 可视化代预约 | 管理员可为任意学生预约座位 |
| 🚫 可视化取消 | 选择座位批量取消预约 |
| 👥 用户管理 | 设置用户状态（正常/黑名单/白名单） |
| 🏷️ 角色管理 | 设置用户角色（普通学生/负责人） |
| 📊 批量操作 | 批量审批、取消预约等 |

#### 系统功能
| 功能 | 说明 |
|------|------|
| ⏰ 自动过期 | 超时未审核的预约自动过期 |
| 🔑 门禁密码 | 自动生成并在预约时段前发送 |
| 🧹 定时清理 | 自动清理过期数据 |
| 🏛️ 多教室支持 | 支持多个教室独立管理 |
| 📐 灵活布局 | 自定义教室座位布局（座位/过道） |

### 预约状态说明
| 状态 | 图标 | 说明 |
|------|------|------|
| 待审核 | ⏳ | 已提交，等待管理员审批 |
| 已通过 | ✅ | 审批通过，可正常使用 |
| 已拒绝 | ❌ | 审批未通过 |
| 已取消 | ⚪ | 用户主动取消 |
| 已过期 | ⏰ | 超时未审核或截止时间已过 |

### 特殊标记
| 标记 | 说明 |
|------|------|
| 👮 管理员操作 | 由管理员代为创建的预约 |
| 🚫 被管理员取消 | 管理员取消的已通过预约 |

---

## 系统架构

```
RoomReservationSystem/v2/
├── config/                 # Django 项目配置
│   ├── settings.py         # 主配置文件
│   ├── urls.py             # URL 路由
│   └── wsgi.py / asgi.py   # 部署配置
├── core/                   # 核心应用
│   ├── models.py           # 数据模型
│   ├── views.py            # 视图函数
│   ├── admin.py            # Admin 后台配置
│   ├── mail_backends.py    # 邮件后端
│   ├── templates/core/     # HTML 模板
│   └── management/commands/# 管理命令
│       ├── cleanup.py              # 清理过期数据
│       ├── cleanup_scheduler.py    # 定时清理调度器
│       └── send_access_codes.py    # 发送门禁密码
├── db.sqlite3              # SQLite 数据库
└── manage.py               # Django 管理脚本
```

### 数据模型

```
Student (学生)
├── student_id      # 学号（唯一）
├── password        # 密码（哈希存储）
├── status          # 状态：normal/blacklist/whitelist
├── role            # 角色：user/manager
├── violation_count # 违规次数
└── is_auto_created # 是否自动创建

Classroom (教室)
├── name            # 教室名称
├── layout          # 座位布局（1=座位, 0=过道）
└── is_active       # 是否启用

Reservation (预约)
├── batch_id        # 批次ID（同次提交共享）
├── student         # 学生（外键）
├── classroom       # 教室（外键）
├── seat_row/col    # 座位行/列
├── date            # 预约日期
├── time_slot       # 时间段
├── status          # 状态
├── is_admin_action # 管理员操作标记
└── cancelled_seats_info # 取消座位信息（JSON）

AccessCode (门禁密码)
├── classroom       # 教室
├── date            # 日期
├── time_slot       # 时间段
├── code            # 密码
└── notified        # 是否已通知
```

---

## 安装与配置

### 环境要求
- Python 3.10+
- Django 5.2+

### 安装步骤

```bash
# 1. 克隆/进入项目目录
cd RoomReservationSystem/v2

# 2. 创建虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # macOS/Linux
# venv\Scripts\activate   # Windows

# 3. 安装依赖
pip install django

# 4. 数据库迁移
rm -rf core/migrations
mkdir core/migrations
touch core/migrations/__init__.py
python manage.py makemigrations
python manage.py migrate

# 5. 创建管理员账户
python manage.py createsuperuser

# 6. 启动开发服务器
python manage.py runserver 5678
```

### 访问地址
- 用户界面：http://127.0.0.1:5678/
- 管理后台：http://127.0.0.1:5678/admin/

---

## 用户手册

### 1. 登录系统

1. 打开首页 `http://127.0.0.1:5678/`
2. 输入学号，点击「登录」
3. 首次登录会自动注册账户

> 💡 **提示**：可选设置密码保护账户，点击「设置密码」按钮

### 2. 预约座位

1. 登录后进入「预约」页面
2. 选择教室、日期、时间段
3. 点击选择空闲座位（绿色）
4. 点击「提交预约」

**座位颜色说明**：
- 🟢 **绿色**：空闲可选
- 🔴 **红色**：已被他人占用
- 🟡 **黄色**：他人待审核中
- 🔵 **蓝色**：我的待审核
- 🟣 **紫色**：我的已通过
- ⬜ **灰色**：过道/不可选

**预约限制**：
- 普通用户：可预约未来 **2 天**内的座位
- 负责人/VIP：可预约未来 **7 天**内的座位
- 必须在时间段开始前 **30 分钟**之前完成预约

### 3. 查看/取消预约

1. 点击右上角「我的预约」
2. 查看所有预约记录
3. 可按状态筛选：全部/待审核/已通过/已拒绝/已取消/已过期
4. 点击「取消」按钮取消预约（需在截止时间前）

### 4. 接收门禁密码

- 预约通过后，系统会在时间段开始前 **15 分钟**发送门禁密码邮件
- 邮件发送至：`学号@hust.edu.cn`

### 5. 申请升级为负责人

负责人可享受更长的预约时间范围。

**申请方式**（根据系统配置）：
- **隐藏入口**：在首页连续点击用户名 **10 次**
- **显式按钮**：点击页面右侧的「申请升级」按钮

---

## 管理员手册

### 1. 登录管理后台

1. 访问 `http://127.0.0.1:5678/admin/`
2. 使用超级管理员账户登录

### 2. 管理教室

**添加教室**：
1. 进入「Classrooms」→「添加」
2. 输入教室名称
3. 设置座位布局（使用 `1` 表示座位，`0` 表示过道）

**布局示例**：
```
11111011111
11111011111
00000000000
11111011111
11111011111
```

### 3. 审批预约

**方式一：邮件审批**
- 收到预约通知邮件后，点击邮件中的「批准」或「拒绝」链接

**方式二：后台批量审批**
1. 进入「Reservations」
2. 勾选需要审批的预约
3. 选择操作：「通过选中预约」或「拒绝选中预约」
4. 点击「执行」

### 4. 可视化代预约

1. 进入「可视化预约」页面：`/admin/visual-booking/`
2. 选择教室、日期、时间段
3. 输入目标学生学号
4. 选择座位并提交

> 📝 管理员代预约的座位会直接设为「已通过」状态，并标记「👮 管理员操作」

### 5. 可视化取消预约

1. 进入「可视化取消」页面：`/admin/visual-cancel/`
2. 选择教室、日期、时间段
3. 勾选需要取消的座位
4. 点击「取消选中」

**取消规则**：
- **待审核预约**：直接取消（会取消所有竞争同一座位的申请）
- **已通过预约**：需在截止时间前取消，会发送邮件通知用户

### 6. 管理用户

**设置用户状态**：
- **正常**：正常使用所有功能
- **黑名单**：禁止预约
- **白名单**：预约自动通过

**设置用户角色**：
- **普通学生**：默认角色
- **负责人/VIP**：可预约更长时间范围

### 7. 处理升级申请

1. 进入「Promotion requests」
2. 查看待处理的申请
3. 选择「通过」或「拒绝」

或通过邮件链接直接处理。

---

## 配置说明

所有配置项在 `config/settings.py` 中：

### 基础配置

```python
# 网站域名（用于生成邮件链接）
SITE_DOMAIN = 'http://127.0.0.1:5678'

# 管理员邮箱
ADMIN_EMAIL = 'admin@hust.edu.cn'
```

### 时间段配置

```python
TIME_SLOTS = (
    (1, '08:00 - 10:00'),
    (2, '10:00 - 12:00'),
    (3, '14:00 - 16:00'),
    (4, '16:00 - 18:00'),
    (5, '19:00 - 22:00'),
)
```

### 预约规则配置

```python
# 预约/取消截止时间（分钟）：必须在时间段开始前 N 分钟完成
RESERVATION_BOOKING_WINDOW_MINUTES = 30

# 普通用户可预约的最大天数范围
RESERVATION_MAX_DAYS_AHEAD = 2

# 负责人可预约的最大天数范围
RESERVATION_MAX_DAYS_AHEAD_MANAGER = 7

# 超时未审核自动过期阈值（小时）
RESERVATION_TIMEOUT_HOURS = 24
```

### 门禁密码配置

```python
# 门禁密码通知提前时间（分钟）
ACCESS_CODE_NOTIFY_MINUTES = 15

# 固定门禁密码（设为 None 则使用随机6位数字）
ACCESS_CODE_FIXED = '123456'
# ACCESS_CODE_FIXED = None  # 使用随机密码
```

### 升级申请配置

```python
# 是否启用隐藏的升级申请入口（10次点击触发）
PROMOTION_ENABLE_10CLICK = True

# 是否显示显式的「申请升级」按钮
PROMOTION_SHOW_BUTTON = False
```

### 邮件配置

```python
# 开发环境：在控制台打印邮件（支持中文）
EMAIL_BACKEND = 'core.mail_backends.DecodedConsoleBackend'

# 生产环境示例（SMTP）：
# EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
# EMAIL_HOST = 'smtp.example.com'
# EMAIL_PORT = 587
# EMAIL_USE_TLS = True
# EMAIL_HOST_USER = 'your-email@example.com'
# EMAIL_HOST_PASSWORD = 'your-password'
```

---

## 定时任务

### 清理过期数据

```bash
# 手动执行一次清理
python manage.py cleanup

# 启动定时清理调度器（每30分钟执行一次）
python manage.py cleanup_scheduler
```

**清理内容**：
- 超过 24 小时未审核的预约 → 标记为「已过期」
- 截止时间已过的待审核预约 → 标记为「已过期」
- 7 天前的过期/取消/拒绝记录 → 删除

### 发送门禁密码

```bash
# 手动发送门禁密码
python manage.py send_access_codes

# 在清理调度器中自动执行（无需单独运行）
```

**发送规则**：
- 在时间段开始前 15 分钟发送
- 每个时段只发送一次
- 发送给该时段所有已通过预约的用户

---

## 注意事项

### 开发环境
1. 默认使用 SQLite 数据库，适合开发测试
2. 邮件在控制台打印，不会真实发送
3. `DEBUG = True`，会显示详细错误信息

### 生产环境部署
1. 设置 `DEBUG = False`
2. 配置正式的数据库（如 PostgreSQL）
3. 配置 SMTP 邮件服务
4. 设置 `SECRET_KEY` 为安全的随机值
5. 配置 `ALLOWED_HOSTS`
6. 使用 Gunicorn + Nginx 部署
7. 启用 HTTPS

### 安全建议
1. 定期备份数据库
2. 限制管理后台访问IP
3. 启用 CSRF 保护（默认已启用）
4. 使用强密码策略

---

## 技术栈

- **后端**：Django 5.2.9
- **数据库**：SQLite（开发）/ PostgreSQL（生产推荐）
- **前端**：原生 HTML + CSS + JavaScript
- **邮件**：Django 内置邮件系统

---

## 版本信息

- **版本**：v2.0
- **最后更新**：2025年12月18日
- **Python 版本**：3.10+
- **Django 版本**：5.2.9

---

## 许可证

本项目仅供学习交流使用。
