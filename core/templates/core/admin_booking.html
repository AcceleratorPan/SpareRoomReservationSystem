<!DOCTYPE html>
<html>
<head>
    <title>ç®¡ç†å‘˜åå°é€‰åº§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* å¤ç”¨å¤§éƒ¨åˆ†åŸºç¡€æ ·å¼ */
        body { font-family: sans-serif; padding: 20px; background: #eee; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px;}
        .controls { display: flex; gap: 10px; margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 6px;}
        
        /* ç®¡ç†å‘˜ç‰¹æœ‰çš„è¾“å…¥æ¡† */
        .admin-input { border: 2px solid #E91E63; padding: 8px; border-radius: 4px; font-weight: bold; width: 150px;}

        /* çŸ©é˜µæ ·å¼å¤ç”¨ */
        .grid-wrapper { 
            overflow-x: auto; 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .row { display: flex; gap: 6px; margin-bottom: 6px; }
        .cell { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 11px; cursor: default; }
        
        .aisle { background: transparent; }
        .seat.free { background: #e0e0e0; cursor: pointer; color: #333;}
        .seat.free:hover { background: #ccc; }
        .seat.selected { background: #E91E63; color: white; border: 2px solid #C2185B;} /* ç®¡ç†å‘˜é€‰åº§ç”¨éªšç²‰è‰² */
        
        .seat.approved { background: #333; color: white; opacity: 0.6; }
        .seat.pending { background: #FF9800; color: white; opacity: 0.8; }

        .tooltip { font-size: 10px; text-align: center; line-height: 1.1; }
        .logout-btn {
            display: inline-block;
            padding: 6px 10px;
            background: #e53935;
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            font-size: 13px;
            margin-right: 8px;
        }
        .logout-btn:hover { background: #c62828; }
        /* è®²å°æ ·å¼ï¼Œå’Œç”¨æˆ·ç«¯ä¿æŒä¸€è‡´ */
        .podium { 
            width: 160px; height: 34px; 
            background: #FF9800; color: white; 
            border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 700; margin: 8px auto 14px auto; 
            box-shadow: 0 2px 6px rgba(255,152,0,0.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <div style="display:flex; align-items:center; gap:10px;">
                <a href="{% url 'logout' %}" class="logout-btn">ç™»å‡º</a>
                <h2 style="margin:0;">ğŸ›  ç®¡ç†å‘˜å¼ºåˆ¶é€‰åº§ç³»ç»Ÿ</h2>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <a href="{% url 'admin_cancel' %}?classroom_id={{ curr_cls.id }}&date={{ date }}&slot={{ current_slot }}" style="background:#c62828; color:white; padding:8px 12px; border-radius:6px; text-decoration:none; font-weight:600;">ğŸš« å–æ¶ˆé¢„çº¦</a>
                <a href="/admin/">è¿”å› Django åå°</a>
            </div>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div style="padding:10px; background:{% if 'error' in message.tags %}#ffebee; color:#c62828{% else %}#d4edda; color:#155724{% endif %}; margin-bottom:10px; border-radius:6px;">{{ message }}</div>
            {% endfor %}
        {% endif %}

        {% if not can_book %}
            <div style="background:#fff3e0; border:1px solid #ffcc02; padding:10px; border-radius:6px; margin-bottom:15px; color:#e65100;">
                âš ï¸ <strong>å½“å‰æ—¶é—´æ®µæ— æ³•é¢„çº¦</strong>ï¼š{{ booking_error_msg }}
                <br><small>ï¼ˆé¢„çº¦æˆªæ­¢æ—¶é—´ï¼šæ—¶é—´æ®µå¼€å§‹å‰ {{ booking_deadline_minutes }} åˆ†é’Ÿï¼‰</small>
            </div>
        {% endif %}

        <form method="POST" id="adminBookForm">
            {% csrf_token %}
            
            <div style="margin-bottom: 15px;">
                <label><strong>ä¸ºè°é¢„çº¦ (è¾“å…¥å­¦å·):</strong></label>
                <input type="text" name="target_student_id" class="admin-input" placeholder="ä¾‹å¦‚: 1001" {% if not can_book %}disabled{% endif %} required>
                <span style="color: #666; font-size: 12px;">æ³¨æ„ï¼šç®¡ç†å‘˜æ“ä½œå°†ç›´æ¥ã€é€šè¿‡ã€‘ï¼Œå¹¶è¸¢æ‰è¯¥ä½ç½®çš„ç­‰å¾…è€…ã€‚</span>
            </div>

            <div class="controls">
                <select name="dummy_cls" onchange="updateParam('classroom_id', this.value)">
                    {% for c in classrooms %}
                        <option value="{{ c.id }}" {% if c.id == curr_cls.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
                <input type="date" value="{{ date }}" onchange="updateParam('date', this.value)" min="{{ today }}">
                <select onchange="updateParam('slot', this.value)">
                    {% for id, name in time_slots %}
                        <option value="{{ id }}" {% if id == current_slot %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="grid-wrapper">
                <div class="podium">è®²å°</div>
                <div style="display: flex; flex-direction: column;">
                    {% for row in matrix %}
                        <div class="row">
                            {% for cell in row %}
                                
                                {% if cell.type == 'seat' %}
                                    
                                    {% if cell.status == 'free' %}
                                        <div class="cell seat free" 
                                            id="seat-{{ cell.r }}-{{ cell.c }}" 
                                            onclick="toggleSeat({{ cell.r }}, {{ cell.c }})">
                                            {{ cell.r|add:1 }}-{{ cell.c|add:1 }}
                                        </div>
                                    
                                    {% elif cell.status == 'approved' %}
                                        <div class="cell seat approved" title="{{ cell.info }}">
                                            <div class="tooltip">å·²å <br>{{ cell.info|slice:"4:" }}</div>
                                        </div>
                                    
                                    {% else %}
                                        <div class="cell seat pending" 
                                            id="seat-{{ cell.r }}-{{ cell.c }}" 
                                            onclick="toggleSeat({{ cell.r }}, {{ cell.c }})"
                                            title="{{ cell.info }} (ç‚¹å‡»å¼ºåˆ¶è¦†ç›–)">
                                            <div class="tooltip">å¾…å®¡<br>{{ cell.info|slice:"4:" }}</div>
                                        </div>
                                    {% endif %}
                                
                                {% else %}
                                    <div class="cell aisle"></div>
                                {% endif %}

                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <input type="hidden" name="seats_list" id="seatsInput">
            <button type="button" onclick="submitForm()" style="margin-top:20px; padding:10px 20px; background:#E91E63; color:white; border:none; font-size:16px; cursor:pointer; {% if not can_book %}opacity:0.5; cursor:not-allowed;{% endif %}" {% if not can_book %}disabled{% endif %}>
                ğŸš€ å¼ºåˆ¶é¢„çº¦é€‰ä¸­åº§ä½
            </button>
        </form>
    </div>

    <script>
        let selectedSeats = new Set();
        const canBook = {{ can_book|yesno:"true,false" }};

        function updateParam(k, v) {
            let u = new URL(window.location);
            u.searchParams.set(k, v);
            window.location = u;
        }

        function toggleSeat(r, c) {
            let key = `${r}-${c}`;
            let el = document.getElementById(`seat-${key}`);
            if (selectedSeats.has(key)) {
                selectedSeats.delete(key);
                el.classList.remove('selected');
            } else {
                selectedSeats.add(key);
                el.classList.add('selected');
            }
        }

        function submitForm() {
            if (!canBook) {
                alert("å½“å‰ä¸åœ¨é¢„çº¦çª—å£å†…ï¼Œæ— æ³•é¢„çº¦ï¼");
                return;
            }
            let sid = document.querySelector('input[name="target_student_id"]').value;
            if (!sid) { alert("è¯·è¾“å…¥å­¦ç”Ÿå­¦å·ï¼"); return; }
            if (selectedSeats.size === 0) { alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåº§ä½ï¼"); return; }
            
            if (confirm(`ç¡®å®šè¦ä¸ºå­¦ç”Ÿ [${sid}] å¼ºåˆ¶é¢„çº¦è¿™ ${selectedSeats.size} ä¸ªåº§ä½å—ï¼Ÿ\n(å¦‚æœæœ‰å¾…å®¡æ ¸çš„ç«äº‰è€…ï¼Œå°†è¢«ç›´æ¥è¸¢å‡º)`)) {
                document.getElementById('seatsInput').value = Array.from(selectedSeats).join(',');
                document.getElementById('adminBookForm').submit();
            }
        }
    </script>
</body>
</html>