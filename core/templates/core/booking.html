<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½é€‰åº§ç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        /* --- å…¨å±€å¸ƒå±€ --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            padding: 20px; 
            padding-bottom: 90px; /* ä¸ºåº•éƒ¨æ ç•™ç©º */
            background-color: #f5f5f5;
            max-width: 800px;
            margin: 0 auto;
        }

        /* --- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯æ  --- */
        .header { 
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .user-info strong { font-size: 18px; color: #333; }
        .role-badge { 
            font-size: 12px; 
            padding: 3px 8px; 
            border-radius: 4px; 
            color: white; 
            margin-left: 8px; 
            vertical-align: middle;
        }
        .role-user { background: #999; }
        .role-manager { background: #E91E63; }

        .nav-links a { 
            text-decoration: none; 
            color: #007bff; 
            font-size: 14px; 
            margin-left: 15px; 
            font-weight: 500;
        }
        .logout-btn {
            display: inline-block;
            padding: 6px 10px;
            background: #e53935;
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            font-size: 13px;
        }
        .logout-btn:hover { background: #c62828; }

        /* --- ç­›é€‰æ§ä»¶æ  --- */
        .controls { 
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap;
        }
        select, input[type="date"] { 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            background: white;
            font-size: 14px;
            flex: 1; /* æ‰‹æœºç«¯è‡ªåŠ¨æ’‘å¼€ */
            min-width: 120px;
        }

        /* --- åº§ä½çŸ©é˜µå®¹å™¨ --- */
        .grid-wrapper { 
            overflow-x: auto; 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex; 
            flex-direction: column; /* çºµå‘æ’åˆ—ï¼šè®²å°åœ¨ä¸Šæ–¹ */
            align-items: center; /* å±…ä¸­æ˜¾ç¤º */
        }
        .grid-container { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        .row { display: flex; gap: 8px; }

        /* --- æ ¸å¿ƒï¼šåº§ä½æ ·å¼ --- */
        .cell { 
            width: 44px; height: 44px; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 8px; 
            font-size: 12px; font-weight: bold; 
            transition: all 0.2s;
            user-select: none;
            position: relative; /* æ–¹ä¾¿å®šä½è§’æ ‡ */
        }

        /* ç±»å‹ï¼šè¿‡é“ */
        .aisle { background: transparent; pointer-events: none; }

        /* ç±»å‹ï¼šåº§ä½ */
        .seat { color: white; border: 2px solid transparent; box-sizing: border-box; }

        /* çŠ¶æ€ 1: ç©ºé—² (å¯ç‚¹) */
        .seat.free { 
            background: #e0e0e0; 
            color: #666; 
            cursor: pointer; 
        }
        .seat.free:active { transform: scale(0.95); }

        /* çŠ¶æ€ 2: é€‰ä¸­ (ç»¿è‰²) */
        .seat.selected { 
            background: #4CAF50 !important; 
            color: white !important; 
            border-color: #2E7D32 !important;
            box-shadow: 0 4px 6px rgba(76, 175, 80, 0.3);
        }

        /* çŠ¶æ€ 3: åˆ«äººå·²è·æ‰¹ (çº¢è‰²é”æ­») */
        .seat.approved { 
            background: #FF5252; 
            cursor: not-allowed; 
            opacity: 0.9;
        }

        /* çŠ¶æ€ 4: æˆ‘ç”³è¯·ä¸­/æˆ‘å·²è·æ‰¹ (è“è‰²) */
        .seat.mine { 
            background: #2196F3; 
            cursor: default; 
            border: 2px solid #1976D2;
        }
        /* åŒºåˆ† Pending å’Œ Approved */
        .seat.mine.pending { 
            background: #64B5F6; 
            border-style: dashed; 
        }

        /* çŠ¶æ€ 5: åˆ«äººç”³è¯·ä¸­ (æ©™è‰² - å¯æŠ¢!) */
        .seat.other_pending { 
            background: #FF9800; 
            color: white;
            cursor: pointer;
        }
        /* è§’æ ‡æç¤º */
        .seat.other_pending::after {
            content: "æŠ¢";
            position: absolute;
            top: -6px; right: -6px;
            background: #D32F2F;
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            border-radius: 10px;
            border: 1px solid white;
            transform: scale(0.9);
        }

        /* --- åº•éƒ¨å›¾ä¾‹ --- */
        .legend { margin-top: 15px; display: flex; gap: 15px; font-size: 12px; color: #666; justify-content: center; flex-wrap: wrap;}
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .dot { width: 12px; height: 12px; border-radius: 3px; }

        /* --- åº•éƒ¨æ‚¬æµ®æäº¤æ  --- */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white;
            padding: 15px 20px;
            border-top: 1px solid #eee;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            z-index: 1000;
        }
        .status-text { font-size: 14px; color: #333; font-weight: bold;}
        .btn-submit {
            background: #212121;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }
        .btn-submit:not(:disabled):hover { background: #000; }

        /* è®²å°æ ·å¼ï¼šé¡µé¢ä¸Šæ–¹çš„æ©™è‰²çŸ©å½¢æ ‡ç­¾ */
        .podium { 
            width: 140px; height: 34px; 
            background: #FF9800; color: white; 
            border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 700; margin: 8px auto 14px auto; 
            box-shadow: 0 2px 6px rgba(255,152,0,0.25);
        }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; align-items:center; gap:10px;">
            <a href="{% url 'logout' %}" class="logout-btn">ç™»å‡º</a>
            <div class="user-info">
                <strong id="user-name" data-role="{{ student.role }}">{{ student.student_id }}</strong>
                {% if student.role != 'user' %}
                    <span class="role-badge role-{{ student.role }}">
                        {{ student.get_role_display }}
                    </span>
                {% endif %}
            </div>
        </div>
        <div class="nav-links">
            <a href="{% url 'my_bookings' %}">ğŸ“… æˆ‘çš„é¢„çº¦</a>
            {% if student.role == 'user' and promotion_show_button %}
                <a href="{% url 'apply_promotion' %}">âš¡ï¸ ç”³è¯·å‡çº§</a>
            {% endif %}
        </div>
    </div>

    <div class="controls">
        <select onchange="updateParam('classroom_id', this.value)">
            {% for c in classrooms %}
                <option value="{{ c.id }}" {% if c.id == curr_cls.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>

        <input type="date" value="{{ date }}" onchange="updateParam('date', this.value)" min="{{ today }}" max="{{ max_date }}">

        <select onchange="updateParam('slot', this.value)">
            {% for id, name in time_slots %}
                <option value="{{ id }}" {% if id == current_slot %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="grid-wrapper">
        <div class="podium">è®²å°</div>
        <div class="grid-container">
            {% for row in matrix %}
                <div class="row">
                    {% for cell in row %}
                        
                        {% if cell.type == 'aisle' %}
                            <div class="cell aisle"></div>
                        
                        {% else %}
                               {% if cell.is_mine %}
                                  <div class="cell seat mine{% if cell.other_pending %} other_pending{% endif %} {% if cell.status == 'pending' %}pending{% endif %}"
                                      title="æˆ‘çš„åº§ä½">
                                      {% if cell.status == 'approved' %}æˆ‘{% else %}å®¡{% endif %}
                                  </div>
                            
                            {% elif cell.status == 'approved' %}
                                <div class="cell seat approved" title="å·²è¢«å ç”¨">å </div>

                            {% elif cell.status == 'other_pending' %}
                                <div class="cell seat other_pending" 
                                     id="seat-{{ cell.r }}-{{ cell.c }}"
                                     onclick="toggleSeat({{ cell.r }}, {{ cell.c }})">
                                     {{ cell.r|add:1 }}-{{ cell.c|add:1 }}
                                </div>

                            {% else %}
                                <div class="cell seat free" 
                                     id="seat-{{ cell.r }}-{{ cell.c }}"
                                     onclick="toggleSeat({{ cell.r }}, {{ cell.c }})">
                                     {{ cell.r|add:1 }}-{{ cell.c|add:1 }}
                                </div>
                            {% endif %}
                        
                        {% endif %}
                        {% endfor %}
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="dot" style="background:#e0e0e0"></div>ç©ºé—²</div>
        <div class="legend-item"><div class="dot" style="background:#4CAF50"></div>å·²é€‰</div>
        <div class="legend-item"><div class="dot" style="background:#2196F3"></div>æˆ‘çš„</div>
        <div class="legend-item"><div class="dot" style="background:#FF9800"></div>ç«äº‰ä¸­(å¯æŠ¢)</div>
        <div class="legend-item"><div class="dot" style="background:#FF5252"></div>å·²å </div>
    </div>

    <div class="bottom-bar">
        <div class="status-text" id="status-text">è¯·é€‰æ‹©åº§ä½</div>
        <button id="submit-btn" class="btn-submit" onclick="submitBooking()" disabled>æäº¤ç”³è¯·</button>
    </div>

    <form id="bookForm" action="{% url 'submit' %}" method="POST" style="display:none;">
        {% csrf_token %}
        <input name="cid" value="{{ curr_cls.id }}">
        <input name="date" value="{{ date }}">
        <input name="slot" value="{{ current_slot }}">
        <input name="seats_list" id="seatsInput">
    </form>
        <script>
            (function(){
                const nameEl = document.getElementById('user-name');
                if (!nameEl) return;
                const KEY = 'booking_user_clicks';
                // ä½¿ç”¨ sessionStorageï¼Œä½¿è®¡æ•°åœ¨åŒä¸€æ ‡ç­¾é¡µæœ‰æ•ˆï¼Œå…³é—­é¡µé¢åé‡ç½®
                function getCount(){
                    const v = sessionStorage.getItem(KEY);
                    return v ? parseInt(v,10) : 0;
                }
                function setCount(n){ sessionStorage.setItem(KEY, String(n)); }

                const role = nameEl.dataset.role || '';
                // å¦‚æœå½“å‰ç”¨æˆ·å·²ç»æ˜¯è´Ÿè´£äººï¼Œç¦ç”¨ 10 æ¬¡ç‚¹å‡»å…¥å£
                if (role === 'manager') return;

                {% if promotion_enable_10click %}
                nameEl.style.cursor = 'pointer';
                nameEl.addEventListener('click', function(e){
                    let c = getCount() + 1;
                    setCount(c);
                    if (c >= 10){
                        // è§¦å‘å‡çº§ï¼Œæ¸…ç©ºè®¡æ•°å¹¶è·³è½¬åˆ°ç”³è¯·å‡çº§è·¯ç”±
                        setCount(0);
                        window.location.href = "{% url 'apply_promotion' %}";
                    }
                });
                {% endif %}
            })();
        </script>

    <script>
        // è·å–å½“å‰ç”¨æˆ·è§’è‰²
        const USER_ROLE = "{{ student.role }}"; // 'user' æˆ– 'manager'
        
        // ä½¿ç”¨ Set å­˜å‚¨é€‰ä¸­çš„åº§ä½åæ ‡ 'r-c'
        let selectedSeats = new Set();

        // 1. URL å‚æ•°æ›´æ–° (åˆ‡æ¢æ•™å®¤/æ—¥æœŸæ—¶ç”¨)
        function updateParam(key, value) {
            let url = new URL(window.location.href);
            url.searchParams.set(key, value);
            window.location.href = url.toString();
        }

        // 2. ç‚¹å‡»åº§ä½é€»è¾‘
        function toggleSeat(r, c) {
            const key = `${r}-${c}`;
            const el = document.getElementById(`seat-${key}`);

            if (selectedSeats.has(key)) {
                // å¦‚æœå·²é€‰ï¼Œç‚¹å‡»å–æ¶ˆ
                selectedSeats.delete(key);
                el.classList.remove('selected');
            } else {
                // å¦‚æœæ˜¯ã€æ™®é€šç”¨æˆ·ã€‘ï¼Œä¸”å·²ç»é€‰äº†ä¸€ä¸ªï¼Œå…ˆå–æ¶ˆæ—§çš„
                if (USER_ROLE === 'user' && selectedSeats.size >= 1) {
                    const oldKey = selectedSeats.values().next().value;
                    const oldEl = document.getElementById(`seat-${oldKey}`);
                    if (oldEl) oldEl.classList.remove('selected');
                    selectedSeats.clear();
                }
                
                // é€‰ä¸­æ–°çš„
                selectedSeats.add(key);
                el.classList.add('selected');
            }
            
            updateUI();
        }

        // 3. æ›´æ–° UI (åº•éƒ¨æ )
        function updateUI() {
            const count = selectedSeats.size;
            const textEl = document.getElementById('status-text');
            const btnEl = document.getElementById('submit-btn');

            if (count === 0) {
                textEl.innerText = "è¯·é€‰æ‹©åº§ä½";
                btnEl.disabled = true;
                btnEl.innerText = "æäº¤ç”³è¯·";
            } else {
                textEl.innerText = `å·²é€‰ ${count} ä¸ªåº§ä½`;
                btnEl.disabled = false;
                btnEl.innerText = `ç¡®è®¤é¢„çº¦ (${count})`;
            }
        }

        // 4. æäº¤é€»è¾‘
        function submitBooking() {
            if (selectedSeats.size === 0) return;

            const seatsArr = Array.from(selectedSeats);
            // ç®€å•çš„å®¢æˆ·ç«¯æ ¡éªŒ
            if (USER_ROLE === 'user' && seatsArr.length > 1) {
                alert("æ™®é€šç”¨æˆ·æ¯æ¬¡åªèƒ½é¢„çº¦ 1 ä¸ªåº§ä½ï¼");
                return;
            }

            if (confirm(`ç¡®è®¤ç”³è¯·é¢„çº¦è¿™ ${seatsArr.length} ä¸ªåº§ä½å—ï¼Ÿ`)) {
                // å°† Set è½¬ä¸ºå­—ç¬¦ä¸² "0-1,0-2" å¡«å…¥éšè—è¡¨å•
                document.getElementById('seatsInput').value = seatsArr.join(',');
                document.getElementById('bookForm').submit();
            }
        }
    </script>
</body>
</html>